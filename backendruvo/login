from google_auth_oauthlib.flow import Flow
import pickle
import os

# Permisos m√≠nimos necesarios para Gmail
SCOPES = ['https://www.googleapis.com/auth/gmail.readonly']

def login_gmail():
    creds = None

    # Si ya existe un token guardado, usarlo
    if os.path.exists('token.pickle'):
        with open('token.pickle', 'rb') as token:
            creds = pickle.load(token)

    # Si no hay credenciales v√°lidas, iniciar flujo de login
    if not creds or not creds.valid:
        flow = Flow.from_client_secrets_file(
            'credentials.json',
            scopes=SCOPES,
            redirect_uri='http://127.0.0.1:5000/google_login/google/authorized'  # Debe coincidir con el redirect_uri registrado en Google Cloud
        )
        auth_url, state = flow.authorization_url(
            access_type='offline',
            include_granted_scopes='true'
        )

        print(f"üîó Redirige al usuario a esta URL para iniciar sesi√≥n: {auth_url}")
        # A partir de ac√°, deber√≠as redirigir al usuario a `auth_url` desde el frontend

        # IMPORTANTE: No se puede guardar el token todav√≠a, eso se hace despu√©s del callback

    return

# Ejecutar login
if __name__ == '__main__':
    login_gmail()
