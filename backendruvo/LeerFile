
from google_auth_oauthlib.flow import InstalledAppFlow
from googleapiclient.discovery import build
import os.path
import pickle

# 1. Define los permisos que necesitas (leer correos)
SCOPES = ['https://www.googleapis.com/auth/gmail.readonly']

# 2. Ruta al archivo JSON de credenciales
CREDENTIALS_FILE = 'C:\Users\48386552\Downloads\credentials.json'

def main():
    creds = None

    # 3. Guarda el token de acceso localmente si ya lo autorizaste antes
    if os.path.exists('token.pickle'):
        with open('token.pickle', 'rb') as token:
            creds = pickle.load(token)

    # 4. Si no hay token o está vencido, pide iniciar sesión
    if not creds or not creds.valid:
        flow = InstalledAppFlow.from_client_secrets_file(CREDENTIALS_FILE, SCOPES)
        creds = flow.run_local_server(port=0)

        # Guarda el token para la próxima vez
        with open('token.pickle', 'wb') as token:
            pickle.dump(creds, token)

    # 5. Construye el servicio de Gmail
    service = build('gmail', 'v1', credentials=creds)

    # 6. Obtén una lista de los últimos 5 correos
    results = service.users().messages().list(userId='me', maxResults=5).execute()
    messages = results.get('messages', [])

    # 7. Muestra un resumen de cada correo
    for message in messages:
        msg = service.users().messages().get(userId='me', id=message['id']).execute()
        print(f"Mensaje ID: {message['id']}")
        print(f"Fragmento: {msg['snippet']}")
        print("-" * 40)

if __name__ == '__main__':
    main()
